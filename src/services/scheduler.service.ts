import { IHabitRepository } from '../infrastructure/habit-repository';
import { Recommendation, RecommendationType } from '../domain/gamification';

/**
 * –°–µ—Ä–≤—ñ—Å –ù—ñ—á–Ω–æ–≥–æ –ü–ª–∞–Ω—É–≤–∞–ª—å–Ω–∏–∫–∞ (Scheduler).
 * * –ó–≥—ñ–¥–Ω–æ –∑ —Ç–µ—Ö–Ω—ñ—á–Ω–∏–º –∑–∞–≤–¥–∞–Ω–Ω—è–º, —Ü–µ–π —Å–µ—Ä–≤—ñ—Å –º–∞—î –∑–∞–ø—É—Å–∫–∞—Ç–∏—Å—è —â–æ–¥–Ω—è –æ 23:59.
 * –í—ñ–Ω –∞–Ω–∞–ª—ñ–∑—É—î –ø—Ä–æ–≥—Ä–µ—Å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –∑–∞ –¥–µ–Ω—å, –≤–∏—è–≤–ª—è—î –ø—Ä–æ–±–ª–µ–º–∏ (–ø—Ä–æ–ø—É—Å–∫–∏)
 * —Ç–∞ –≥–µ–Ω–µ—Ä—É—î –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω—ñ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó (AI Suggestions).
 */
export class SchedulerService {
    /**
     * @param habitRepo - –†–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ–π –¥–ª—è –¥–æ—Å—Ç—É–ø—É –¥–æ –¥–∞–Ω–∏—Ö –∑–≤–∏—á–æ–∫
     */
    constructor(private habitRepo: IHabitRepository) {}

    /**
     * –û—Å–Ω–æ–≤–Ω–∏–π –º–µ—Ç–æ–¥ –Ω—ñ—á–Ω–æ—ó –ø—Ä–æ—Ü–µ–¥—É—Ä–∏.
     * 1. –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î –≤—Å—ñ –∑–≤–∏—á–∫–∏.
     * 2. –ü–µ—Ä–µ–≤—ñ—Ä—è—î, —á–∏ –Ω–µ "–∑–∞–ø—É—Å—Ç–∏–≤" –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á —è–∫—É—Å—å –∑–≤–∏—á–∫—É (—Å—Ç—Ä—ñ–∫ = 0).
     * 3. –Ø–∫—â–æ –∑–Ω–∞–π–¥–µ–Ω–æ –ø—Ä–æ–±–ª–µ–º—É - —Å—Ç–≤–æ—Ä—é—î Recommendation (User Story: Corrective Feedback).
     * * @returns Promise<string[]> - –ú–∞—Å–∏–≤ –ª–æ–≥—ñ–≤ –¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è —É –∑–≤—ñ—Ç—ñ
     */
    async processNightlyRoutine(): Promise<string[]> {
        const logs: string[] = [];
        const habits = await this.habitRepo.findAll();

        logs.push(`üåô –ó–∞–ø—É—Å–∫ –Ω—ñ—á–Ω–æ–≥–æ –ø–ª–∞–Ω—É–≤–∞–ª—å–Ω–∏–∫–∞ –¥–ª—è ${habits.length} –∑–≤–∏—á–æ–∫...`);

        for (const habit of habits) {
            // –õ–æ–≥—ñ–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó (–∑–≥—ñ–¥–Ω–æ –ø. 4.4 –¥–æ–∫—É–º–µ–Ω—Ç—É)
            // –£–º–æ–≤–∞: "–Ø–∫—â–æ —Å—Ç—Ä—ñ–∫ –≤–ø–∞–≤ –¥–æ 0 (–≤—Ç—Ä–∞—Ç–∞ –ø—Ä–æ–≥—Ä–µ—Å—É), —Ç—Ä–µ–±–∞ –ø—ñ–¥—Ç—Ä–∏–º–∞—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞"
            
            if (habit.currentStreak === 0) {
                 logs.push(`‚ùå –ó–≤–∏—á–∫–∞ "${habit.name}" –º–∞—î –ø–æ–≥–∞–Ω—É —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É.`);
                 
                 // –°—Ç–≤–æ—Ä—é—î–º–æ –ø–æ—Ä–∞–¥—É –∫–æ—Ä–∏–≥—É–≤–∞–ª—å–Ω–æ–≥–æ —Ç–∏–ø—É
                 const rec = new Recommendation(
                     Date.now().toString(),
                     habit.id,
                     RecommendationType.CORRECTIVE,
                     `–£–≤–∞–≥–∞! –¢–∏ –∑–∞–ø—É—Å—Ç–∏–≤ –∑–≤–∏—á–∫—É "${habit.name}". –°–ø—Ä–æ–±—É–π –∑–º–µ–Ω—à–∏—Ç–∏ —Å–∫–ª–∞–¥–Ω—ñ—Å—Ç—å.`,
                     true
                 );
                 
                 await this.habitRepo.addRecommendation(rec);
                 logs.push(`   -> üí° –°—Ç–≤–æ—Ä–µ–Ω–æ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—é –¥–ª—è "${habit.name}"`);
            } else {
                logs.push(`‚úÖ –ó–≤–∏—á–∫–∞ "${habit.name}" –≤ –Ω–æ—Ä–º—ñ (Streak: ${habit.currentStreak})`);
            }
        }
        
        logs.push("üèÅ –ù—ñ—á–Ω–∞ –ø—Ä–æ—Ü–µ–¥—É—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞.");
        return logs;
    }
}